@using YSI.CurseOfSilverCrown.Core.ViewModels;
@using YSI.CurseOfSilverCrown.Core.Parameters;
@using Newtonsoft.Json;
@model YSI.CurseOfSilverCrown.Core.Database.Models.Command

@{
    ViewData["Title"] = "Нападение";
    var resourses = ViewBag.Resourses as Dictionary<string, List<int>>;
    var targetOrganizations = ViewBag.TargetOrganizations as IEnumerable<OrganizationInfo>;
    var targetOrganizationsJson = @Html.Raw(JsonConvert.SerializeObject(targetOrganizations));
    var isCreate = Model == null;
}

<h1>@(isCreate ? "Создание" : "Редактирование")</h1>

<h4>Нападение</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action=@(isCreate ? "Create" : "Edit")>
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            @if (isCreate)
            {
                <input type="hidden" asp-for="Id" />
            }
            <input type="hidden" asp-for="Type" value="2" />
            <div id="commandTarget" class="form-group">
                <label asp-for="TargetOrganizationId" class="control-label"></label>
                <select asp-for="TargetOrganizationId" class="form-control" asp-items="ViewBag.TargetOrganizationId"
                        onchange="onTargetOrWarriorsChanged()"></select>
                <span asp-validation-for="TargetOrganizationId" class="text-danger"></span>
            </div>
            <div id="warriors" class="form-group">
                <label asp-for="Warriors" class="control-label"></label>
                <input asp-for="Warriors" class="form-control" type="range" min="1" max="@resourses["Воины"][2]"
                       onchange="onTargetOrWarriorsChanged()" />
                <span asp-validation-for="Warriors" class="text-danger"></span>
            </div>
            <span id="expectation">
                Кол-во ваших воинов: -, кол-во воинов соперника: -, шансы на победу, если противник будет в защите и без поддержки: -
            </span>
            <div class="form-group">
                <input type="submit" value="Сохранить" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div class="row">
    <p>
        Нападение - команда атаковать чужую провинцию с целью её захвата или наоборот освобождения себя от вассальной клятвы.
        Вы не можете нападать на своих вассалов.
        Если вы имеете сюзерена, то не можете нападать на другие провинции, но можете атаковать провинцию сюзерена, чтобы получить независимость.
    </p>
</div>

<div>
    <a asp-action="Index">К списку</a>
</div>

<script type="text/javascript">

    window.onload = function () {
        document.getElementById("Warriors").value = @Math.Min(500, resourses["Воины"][2]);
        onTargetOrWarriorsChanged();
    };

    function onTargetOrWarriorsChanged() {
        let targetId = document.getElementById("TargetOrganizationId").value;
        let array = @targetOrganizationsJson;
        let target = array.find(e => e.Id == targetId);
        let warriors = parseInt(document.getElementById("Warriors").value);
        let chanseStr = 'неизвестны';
        if (warriors * 0.8 >= target.Warriors * @WarConstants.WariorDefenseSupport * 1.2)
            chanseStr = 'обсолютная победа';
        else if (warriors * 0.95 >= target.Warriors * @WarConstants.WariorDefenseSupport * 1.05)
            chanseStr = 'хорошие шансы на победу';
        else if (warriors * 1.05 >= target.Warriors * @WarConstants.WariorDefenseSupport * 0.95)
            chanseStr = 'война на равных';
        else if (warriors * 1.2 >= target.Warriors * @WarConstants.WariorDefenseSupport * 0.8)
            chanseStr = 'победа маловероятна';
        else
            chanseStr = 'никаких шансов';


        document.getElementById("expectation").innerText =
            'Кол-во ваших воинов: ' + warriors + ', кол-во воинов соперника: ' + target.Warriors + ', шансы на победу, если противник будет в защите и без поддержки: ' + chanseStr;
    }

</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
